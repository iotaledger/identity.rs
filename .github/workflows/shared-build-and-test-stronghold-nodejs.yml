name: Shared / Build and test stronghold nodejs

# This workflow builds and optionally tests the stronghold nodejs bindings.
# It is relying on artifacts generated by the `shared-build-wasm` workflow.
# It outputs build artifacts used for publishing.

on:
  workflow_call:
    inputs:
      run-tests:
        description: "Should tests be run"
        required: false
        type: boolean
        default: true
      input-artifact-name:
        description: "Name used for the input Wasm build artifact"
        required: true
        type: string
      output-artifact-name:
        description: "Name used for the output build artifact. Must be set if `upload-binaries-as-artifacts` is true"
        required: false
        type: string

env:
  WORKING_DIRECTORY: bindings/stronghold-nodejs
  APP_NAME: identity-stronghold-nodejs

jobs:
  build:
      defaults:
        run:
          working-directory: bindings/stronghold-nodejs
      env:
        DEBUG: napi:*
        MACOSX_DEPLOYMENT_TARGET: '10.13'
      strategy:
        fail-fast: false
        matrix:
          settings:
            - host: macos-latest
              target: x86_64-apple-darwin
              build: |
                npm run build
                strip -x dist/*.node
            - host: windows-latest
              build: npm run build
              target: x86_64-pc-windows-msvc
            - host: ubuntu-latest
              target: x86_64-unknown-linux-gnu
              generate-dist: true
              docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-debian
              build: |-
                set -e &&
                npm run build --target x86_64-unknown-linux-gnu &&
                strip dist/*.node
            - host: ubuntu-latest
              target: x86_64-unknown-linux-musl
              docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-alpine
              build: set -e && npm run build && strip dist/*.node
            - host: macos-latest
              target: aarch64-apple-darwin
              build: |
                npm run build --target aarch64-apple-darwin
                strip -x dist/*.node
      name: stable - ${{ matrix.settings.target }} - node@18
      runs-on: ${{ matrix.settings.host }}
      steps:
        - uses: actions/checkout@v3
        - name: Setup node
          uses: actions/setup-node@v3
          if: ${{ !matrix.settings.docker }}
          with:
            node-version: 18
            check-latest: true
            cache: npm
            cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
        - name: Install
          uses: dtolnay/rust-toolchain@stable
          if: ${{ !matrix.settings.docker }}
          with:
            toolchain: stable
            targets: ${{ matrix.settings.target }}
        - name: Cache cargo
          uses: actions/cache@v3
          with:
            path: |
              ~/.cargo/registry/index/
              ~/.cargo/registry/cache/
              ~/.cargo/git/db/
              .cargo-cache
              target/
            key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}
        - uses: goto-bus-stop/setup-zig@v2
          if: ${{ matrix.settings.target == 'armv7-unknown-linux-gnueabihf' }}
          with:
            version: 0.10.1
        - name: Setup toolchain
          run: ${{ matrix.settings.setup }}
          if: ${{ matrix.settings.setup }}
          shell: bash
        - name: Download bindings/wasm artifacts
          uses: actions/download-artifact@v2
          with:
            name: ${{ inputs.input-artifact-name }}
            path: bindings/wasm
        - name: Prepare Wasm bindings link
          run: |
            npm ci
            npm link
          working-directory: ./bindings/wasm
        - name: Install dependencies
          run: npm ci --legacy-peer-deps && npm link @iota/identity-wasm
        - name: Setup node x86
          uses: actions/setup-node@v3
          if: matrix.settings.target == 'i686-pc-windows-msvc'
          with:
            node-version: 18
            check-latest: true
            cache: npm
            cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
            architecture: x86
        - name: Build in docker
          uses: addnab/docker-run-action@v3
          if: ${{ matrix.settings.docker }}
          with:
            image: ${{ matrix.settings.docker }}
            options: '--user 0:0 -v ${{ github.workspace }}/.cargo-cache/git/db:/usr/local/cargo/git/db -v ${{ github.workspace }}/.cargo/registry/cache:/usr/local/cargo/registry/cache -v ${{ github.workspace }}/.cargo/registry/index:/usr/local/cargo/registry/index -v ${{ github.workspace }}:/build -w /build/${{ env.WORKING_DIRECTORY }}'
            run: ${{ matrix.settings.build }}
        - name: Build
          run: ${{ matrix.settings.build }}
          if: ${{ !matrix.settings.docker }}
          shell: bash
        - name: List packages
          run: ls -R .
          shell: bash
        - name: Upload binary artifact
          uses: actions/upload-artifact@v3
          with:
            name: bindings-${{ matrix.settings.target }}
            path: ${{ env.WORKING_DIRECTORY }}/dist/${{ env.APP_NAME }}.*.node
            if-no-files-found: error
            retention-days: 1
        # Optionally uploads js / ts dist artifact for later release. Since js is cross-platform it only needs to be uploaded from one matrix target.
        - name: Upload dist artifact
          if: ${{matrix.settings.generate-dist}}
          uses: actions/upload-artifact@v3
          with:
            name: ${{ inputs.output-artifact-name }}
            path: |
              ${{ env.WORKING_DIRECTORY }}/dist/
              !${{ env.WORKING_DIRECTORY }}/dist/${{ env.APP_NAME }}.*.node
            if-no-files-found: error
            retention-days: 1

  test-macOS-windows-binding:
    name: Test bindings on ${{ matrix.settings.target }} - node@${{ matrix.node }}
    needs:
      - build
    defaults:
      run:
        working-directory: bindings/stronghold-nodejs
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-latest
            target: x86_64-pc-windows-msvc
        node:
          - '14'
          - '16'
          - '18'
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          check-latest: true
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
      - name: Install dependencies
        run: npm install
      - name: Download binary artifacts
        uses: actions/download-artifact@v3
        with:
          name: bindings-${{ matrix.settings.target }}
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.output-artifact-name }}
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: List packages
        run: ls -R .
        shell: bash
      - name: Test bindings
        run: npm test

  test-linux-x64-gnu-binding:
    name: Test bindings on Linux-x64-gnu - node@${{ matrix.node }}
    needs:
      - build
    defaults:
      run:
        working-directory: bindings/stronghold-nodejs
    strategy:
      fail-fast: false
      matrix:
        node:
          - '14'
          - '16'
          - '18'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          check-latest: true
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
      - name: Install dependencies
        run: npm install
      - name: Download binary artifacts
        uses: actions/download-artifact@v3
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.output-artifact-name }}
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: List packages
        run: ls -R .
        shell: bash
      - name: Test bindings
        run: docker run --rm -v $(pwd):/build -w /build node:${{ matrix.node }}-slim npm test

  test-linux-x64-musl-binding:
    name: Test bindings on x86_64-unknown-linux-musl - node@${{ matrix.node }}
    needs:
      - build
    defaults:
      run:
        working-directory: bindings/stronghold-nodejs
    strategy:
      fail-fast: false
      matrix:
        node:
          - '14'
          - '16'
          - '18'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          check-latest: true
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
      - name: Install dependencies
        run: |
          # yarn config set supportedArchitectures.libc "musl"
          npm install
      - name: Download binary artifacts
        uses: actions/download-artifact@v3
        with:
          name: bindings-x86_64-unknown-linux-musl
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.output-artifact-name }}
          path: ${{ env.WORKING_DIRECTORY }}/dist
      - name: List packages
        run: ls -R .
        shell: bash
      - name: Test bindings
        run: docker run --rm -v $(pwd):/build -w /build node:${{ matrix.node }}-alpine npm test
  